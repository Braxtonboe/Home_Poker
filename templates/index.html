<!DOCTYPE html>
<html>
<head>
  <title>Poker Profit/Loss Dashboard</title>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    .tab { overflow: hidden; border-bottom: 1px solid #fdfdfd; margin-bottom: 20px; }
    .tab button {
      background-color: #d8d8d8; float: left; border: none; outline: none;
      cursor: pointer; padding: 10px 20px; transition: 0.3s; font-size: 16px;
    }
    .tab button:hover { background-color: #ffffff; }
    .tab button.active { background-color: #ffffff; }
    .tabcontent { display: none; padding: 10px 0; }

    /* Stats Cards */
    .stats-cards { 
    display: grid; 
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); 
    gap: 20px; 
    margin-top: 20px; 
  }

  .card { 
    padding: 20px; 
    border-radius: 15px; 
    color: rgb(255, 255, 255); 
    font-weight: bold; 
    box-shadow: 0 4px 15px rgba(0,0,0,0.2); 
    transition: transform 0.2s, box-shadow 0.2s; 
  }
  .card:hover { 
    transform: translateY(-5px); 
    box-shadow: 0 6px 20px rgba(0,0,0,0.3); 
  }

  .card.overall { background: linear-gradient(135deg, #252525, #292929); }
  .card.players { background: linear-gradient(135deg, #252525, #292929); }
  .card.session { background: linear-gradient(135deg, #252525, #292929); }

  .card h3 { font-size: 20px; margin-bottom: 10px; }
  .card .stat-value { font-size: 24px; margin: 5px 0; }
  .card .positive { color: #4CAF50; }
  .card .negative { color: #F44336; }

  .progress { background:#000000; border-radius:8px; overflow:hidden; height:10px; margin:5px 0; }
  .progress div { height:100%; border-radius:8px; }

  .player-card {
  background: rgba(255,255,255,0.1);
  border-radius: 10px;
  padding: 10px;
  margin: 10px 0;
  box-shadow: inset 0 2px 5px rgba(0,0,0,0.2);
}
.sparkline { width: 100%; height: 60px; }
.stat-value { margin: 8px 0; font-size: 16px; }
.positive { color: #4CAF50; font-weight: bold; }
.negative { color: #F44336; font-weight: bold; }

    table { border-collapse: collapse; width: 100%; margin-top: 15px; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
    th { background-color: #8b8b8b; }
    tr:nth-child(even){background-color: #e4e4e4;}
    
  </style>
</head>
<body>
  <h1>Poker Profit/Loss Dashboard</h1>

  <div class="tab">
    <button class="tablinks" onclick="openTab(event, 'Stats')" id="defaultOpen">Stats</button>
    <button class="tablinks" onclick="openTab(event, 'Graphs')">Graphs</button>
    <button class="tablinks" onclick="openTab(event, 'Data')">Log Book</button>
  </div>

  <!-- Stats Page -->
  <div id="Stats" class="tabcontent">
    <h2>üìä Stats</h2>
    <div id="summary"></div>
  </div>

  <!-- Graphs Page -->
  <div id="Graphs" class="tabcontent">
    <h2>üìà Graphs</h2>
    <div id="total" style="width:80%;height:400px;margin-bottom:30px;"></div>
    <div id="cumulative" style="width:80%;height:400px;margin-bottom:30px;"></div>
    <div id="average" style="width:80%;height:400px;"></div>
  </div>

  <!-- Data Page -->
  <div id="Data" class="tabcontent">
    <h2>üìÑ Log Book</h2>
    <div id="csvTable"></div>
  </div>

  <script>
    function openTab(evt, tabName) {
      const tabcontent = document.getElementsByClassName("tabcontent");
      for (let i = 0; i < tabcontent.length; i++) tabcontent[i].style.display = "none";
      const tablinks = document.getElementsByClassName("tablinks");
      for (let i = 0; i < tablinks.length; i++) tablinks[i].className = tablinks[i].className.replace(" active", "");
      document.getElementById(tabName).style.display = "block";
      evt.currentTarget.className += " active";
    }

    document.getElementById("defaultOpen").click();

    function loadData() {
      fetch("/data")
        .then(res => res.json())
        .then(rows => {
          const players = {};
          let biggestSingleWin = { player: "", value: -Infinity, date: "" };
          let biggestSingleLoss = { player: "", value: Infinity, date: "" };

          // organize data
          rows.forEach(r => {
            const player = r.player_name;
            const profit = parseFloat(r.profit_loss);
            const date = r.date;

            if (!players[player]) players[player] = { profits: [], dates: [], raw: [] };
            players[player].profits.push(profit);
            players[player].dates.push(date);
            players[player].raw.push(r.profit_loss);

            if (profit > biggestSingleWin.value) biggestSingleWin = { player, value: profit, date };
            if (profit < biggestSingleLoss.value) biggestSingleLoss = { player, value: profit, date };
          });

          // Total per player
          const totals = {};
          Object.keys(players).forEach(player => totals[player] = players[player].profits.reduce((a,b)=>a+b,0));

          const biggestWinner = Object.keys(totals).reduce((a,b) => totals[a]>totals[b]?a:b);
          const biggestLoser = Object.keys(totals).reduce((a,b) => totals[a]<totals[b]?a:b);

          // Compute player volatility & streaks
          const winLossRates = {};
          const volatility = {};
          // Helper function for longest streaks
          function getLongestStreak(arr, isWin) {
            let max = 0, cur = 0;
            arr.forEach(val => {
              if (val === 0) return; // skip zeros, don't reset streak
              if ((isWin && val > 0) || (!isWin && val < 0)) {
                cur++;
                if (cur > max) max = cur;
              } else {
                cur = 0;
              }
            });
            return max;
          }

          const longestWinStreaks = {};
          const longestLossStreaks = {};
          Object.keys(players).forEach(player => {
            let wins=0, losses=0, sum=0, sumSq=0, count=0;
            let streak=0;
            players[player].profits.forEach(val => {
              if(Object.is(val,-0)) return;
              if(val>0) wins++; if(val<0) losses++;
              sum+=val; sumSq+=val*val; count++;
              streak = val>=0? (streak>0?streak+1:1):(streak<0?streak-1:-1);
            });
            const totalRounds=wins+losses;
            winLossRates[player] = {win:wins, total:totalRounds, loss:losses};
            volatility[player] = count>1? Math.sqrt((sumSq - sum*sum/count)/(count-1)):0;
            longestWinStreaks[player] = getLongestStreak(players[player].profits, true);
            longestLossStreaks[player] = getLongestStreak(players[player].profits, false);
          });

          // Restore current streaks for player cards
          const currentStreaks = {};
          Object.keys(players).forEach(player => {
            let streak = 0;
            players[player].profits.forEach(val => {
              if (Object.is(val, -0)) return;
              if (val === 0) return; // skip zeros, don't reset streak
              streak = val > 0 ? (streak > 0 ? streak + 1 : 1) : (streak < 0 ? streak - 1 : -1);
            });
            currentStreaks[player] = streak;
          });

          const allTimeLongestWinner = Object.keys(longestWinStreaks).reduce((a,b) => longestWinStreaks[a] > longestWinStreaks[b] ? a : b);
          const allTimeLongestLoser = Object.keys(longestLossStreaks).reduce((a,b) => longestLossStreaks[a] > longestLossStreaks[b] ? a : b);

          // Session winners
          let sessionTop = {};
          rows.forEach(r=>{
            const date=r.date;
            const profit=parseFloat(r.profit_loss);
            if(profit>0){
              if(!sessionTop[date]||profit>sessionTop[date].profit) sessionTop[date]={player:r.player_name,profit};
            }
          });

          // --- Build Cards ---
          let html = `<div class="stats-cards">`;

          // 1. Overall Stats (Leaderboard style)
          html+=`
            <div class="card overall">
              <h3>üèÜ Overall Stats</h3>
              <div class="stat-value">Biggest Winner: <span class="positive">${biggestWinner} ($${totals[biggestWinner].toFixed(2)})</span></div>
              <div class="stat-value">Biggest Loser: <span class="negative">${biggestLoser} ($${totals[biggestLoser].toFixed(2)})</span></div>
              <div class="stat-value">üéØ Single Game Win: ${biggestSingleWin.player} ($${biggestSingleWin.value.toFixed(2)} on ${biggestSingleWin.date})</div>
              <div class="stat-value">üíÄ Single Game Loss: ${biggestSingleLoss.player} ($${biggestSingleLoss.value.toFixed(2)} on ${biggestSingleLoss.date})</div>
              <div class="stat-value">üî• All-Time Longest Winning Streak: 
                ${allTimeLongestWinner} (${longestWinStreaks[allTimeLongestWinner]} Wins)</div>
              <div class="stat-value">‚ùÑÔ∏è All-Time Longest Losing Streak: 
                ${allTimeLongestLoser} (${longestLossStreaks[allTimeLongestLoser]} Losses)</div>
            </div>
          `;

          // 2. Player Stats (individual cards with sparkline)
          let playerHtml=`<h3>üë§ Player Stats</h3>`;
          Object.keys(players).forEach(p=>{
            const streak = currentStreaks[p]>0? `üî• ${currentStreaks[p]} Wins`:`‚ùÑÔ∏è ${Math.abs(currentStreaks[p])} Losses`;
            const color = currentStreaks[p]>=0 ? "#4CAF50" : "#F44336";
            const vol = volatility[p].toFixed(2);

            // Sparkline chart container
            const sparkId = `spark_${p.replace(/\s+/g,"_")}`;

            playerHtml+=`
              <div class="player-card">
                <b>${p}</b><br>
                <span style="color:${color};font-size:14px;">${streak}</span><br>
                <small>Volatility: $${vol}</small>
                <div id="${sparkId}" class="sparkline"></div>
                  Win/Loss Ratio: <span class="positive">${winLossRates[p].win}</span> - <span class="negative">${winLossRates[p].loss}</span>
              </div>
            `;
          });
          html+=`<div class="card players">${playerHtml}</div>`;

          // 3. Session Winners
          let sessionHtml=`<h3>üìÖ Session Winners</h3><ul>`;
          Object.keys(sessionTop).sort().forEach(date=>{
            const s=sessionTop[date];
            sessionHtml+=`<li><b>${s.player}</b> won <span class="positive">$${s.profit.toFixed(2)}</span> on ${date}</li>`;
          });
          sessionHtml+=`</ul>`;
          html+=`<div class="card session">${sessionHtml}</div>`;

          html+=`</div>`; // close stats-cards
          document.getElementById("summary").innerHTML = html;

          // --- Add Sparklines with Plotly (ignore only -0) ---
          Object.keys(players).forEach(p=>{
            const sparkId = `spark_${p.replace(/\s+/g,"_")}`;

            // Keep all values except true -0
            const filtered = players[p].profits
              .map((val, idx) => {
                if (Object.is(val, -0)) {
                  return null; // skip negative zero only
                }
                return {x: players[p].dates[idx], y: val};
              })
              .filter(v => v !== null);

            const trace = {
              x: filtered.map(f => f.x),
              y: filtered.map(f => f.y),
              mode: "lines+markers",
              line: { color: "#fff", width: 2 },
              marker: { size: 4 },
            };

            Plotly.newPlot(sparkId, [trace], {
              margin: {t:0, l:0, r:0, b:20},
              height: 80,
              paper_bgcolor: "rgba(0,0,0,0)",
              plot_bgcolor: "rgba(0,0,0,0)",
              xaxis: {visible:false},
              yaxis: {visible:false}
            }, {displayModeBar:false});
          });

          // --- Graphs ---
          const totalData = Object.keys(players).map(p=>({x:[p],y:[totals[p]],type:'bar',name:p}));
          Plotly.newPlot('total', totalData, { title: "Total Profit/Loss per Player" });

          const cumulativeData = Object.keys(players).map(p=>{
            let cum=[]; players[p].profits.reduce((a,b,i)=>cum[i]=a+b,0);
            return {x:players[p].dates,y:cum,mode:'lines+markers',name:p};
          });
          Plotly.newPlot('cumulative', cumulativeData, { title: "Cumulative Profit/Loss Over Time" });

          const averageData = Object.keys(players).map(p=>{
            const filtered = players[p].profits.map((val,idx)=>{
              const rawVal=String(players[p].raw[idx]);
              const isNegZero=Object.is(val,-0);
              const isZeroFloat=(val===0 && rawVal.includes("."));
              return (isNegZero||isZeroFloat)?null:val;
            }).filter(v=>v!==null);
            const avg=filtered.length>0?filtered.reduce((a,b)=>a+b,0)/filtered.length:0;
            return {x:[p],y:[avg],type:'bar',name:p};
          });
          Plotly.newPlot('average', averageData, { title: "Average Profit/Loss per Round" });

          // --- CSV Table ---
          let tableHtml="<table><tr><th>Player</th><th>Profit/Loss</th><th>Date</th></tr>";
          rows.forEach(r=>{
            const profit=parseFloat(r.profit_loss);
            if(Object.is(profit,-0)) return;
            tableHtml+=`<tr><td>${r.player_name}</td><td>${profit.toFixed(2)}</td><td>${r.date}</td></tr>`;
          });
          tableHtml+="</table>";
          document.getElementById("csvTable").innerHTML=tableHtml;

        });
    }

    loadData();
    setInterval(loadData, 10000);
  </script>
</body>
</html>
